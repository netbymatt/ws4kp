//@version=6
indicator("Day of Week Seasonality", overlay = false, max_boxes_count = 500)

//#region ———————————————————— Constants, inputs, and global variables

string TT_SY = "The year to start seasonality calculations."
string TT_PC = "The base color for boxes and table cells that show positive values."
string TT_NC = "The base color for boxes and table cells that show negative values."
string TT_CP = "The cutoff for maximum color intensity."

int startYearInput = input.int(2015, "Starting year", minval = 1800, tooltip = TT_SY, display = display.none)

string COLOR_GRP          = "Color settings"
color  posColorInput      = color.new(input.color(#089981, "Positive Color", group = COLOR_GRP, tooltip = TT_PC), 0)
color  negColorInput      = color.new(input.color(#F23745, "Negative Color", group = COLOR_GRP, tooltip = TT_NC), 0)
int    cutoffPercentInput = input.int(5, "Color intensity cutoff (%)", group = COLOR_GRP, tooltip = TT_CP, display = display.none)

string HEATMAP_GRP        = "Heatmap settings"
string tablePositionInput = input.string("Center", "Table Position", options = ["Left", "Center", "Right"], group = HEATMAP_GRP, display = display.none)
float  tableWidthInput    = input.float(80, "Table Width (%)", maxval = 100, minval = 0, group = HEATMAP_GRP, display = display.none)
float  tableHeightInput   = input.float(95, "Table Height (%)", maxval = 100, minval = 0, group = HEATMAP_GRP, display = display.none)
bool   showAvgInput       = input.bool(true, "Show Averages", group = HEATMAP_GRP)
bool   showStDevInput     = input.bool(true, "Show Standard Deviation", group = HEATMAP_GRP)
bool   showPosInput       = input.bool(true, "Show Percent Positive", group = HEATMAP_GRP)
bool   showMetrics        = showAvgInput or showStDevInput or showPosInput

int currDayOfWeek = dayofweek(time_close - 1)
prevTimeClose     = time_close[1] - 1
int prevBarYear   = year(prevTimeClose)
int prevBarDow    = dayofweek(prevTimeClose)
//#endregion


//#region ———————————————————— Functions and methods

calcColor(float value, int topTranspValue = na) =>
    color naColor     = color.gray
    float heavyTransp = 50
    float lightTransp = 90
    color heavyColor  = color.new(value >= 0 ? posColorInput : negColorInput, heavyTransp)
    color lightColor  = color.new(value >= 0 ? posColorInput : negColorInput, lightTransp)
    color baseColor   = na(value) ? naColor : value >= 0 ? posColorInput : negColorInput
    color transpColor = color.from_gradient(math.abs(value), 0, topTranspValue, lightColor, heavyColor)
    na(topTranspValue) ? baseColor : transpColor

changePercent(float source) => 100.0 * (source - source[1]) / source[1]

method nonNA(array<float> this) =>
    int result = 0
    for item in this
        if not na(item)
            result += 1
    result

method percentPositive(array<float> this) =>
    int countNonNA = 0
    int pos = 0
    for item in this
        if not na(item)
            countNonNA += 1
            if item >= 0
                pos += 1
    100.0 * pos / countNonNA

// Accumulate daily changes by year and day of week
// Returns [yearArray, sumMatrix, countMatrix]
calculateDowChanges(int startYear, int prevBarYear, int prevBarDow) =>
    var matrix<float> sumMatrix   = matrix.new<float>(0, 8, 0.0)
    var matrix<int>   countMatrix = matrix.new<int>(0, 8, 0)
    var array<int>    yearArray   = array.new<int>()

    float prevChange = changePercent(close[1])

    if prevBarYear >= startYear and not na(prevChange)
        // Check if we need a new row for this year
        int rowIdx = yearArray.indexof(prevBarYear)
        if rowIdx == -1
            // New year - add row
            sumMatrix.add_row()
            countMatrix.add_row()
            yearArray.push(prevBarYear)
            rowIdx := yearArray.size() - 1
            // Initialize the new row to zeros
            for col = 0 to 7
                sumMatrix.set(rowIdx, col, 0.0)
                countMatrix.set(rowIdx, col, 0)

        // Accumulate sum and count for this year + day of week
        float oldSum   = sumMatrix.get(rowIdx, prevBarDow)
        int   oldCount = countMatrix.get(rowIdx, prevBarDow)
        sumMatrix.set(rowIdx, prevBarDow, oldSum + prevChange)
        countMatrix.set(rowIdx, prevBarDow, oldCount + 1)

    [yearArray, sumMatrix, countMatrix]
//#endregion


//#region ———————————————————— Main calculations and outputs

[yearIndexArray, sumMatrix, countMatrix] = request.security(
     syminfo.tickerid, "1D", calculateDowChanges(startYearInput, prevBarYear, prevBarDow),
     lookahead = barmerge.lookahead_on
 )

var dayNames = array.from("Year", "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat")

countRows(int dataRows, bool showMetrics, bool showAvgInput, bool showStDevInput, bool showPosInput) =>
    int total = 1 + dataRows
    if showMetrics
        total += 1
        total += showAvgInput ? 1 : 0
        total += showStDevInput ? 1 : 0
        total += showPosInput ? 1 : 0
    total

// Heatmap rendering
if barstate.islast and not na(sumMatrix) and sumMatrix.rows() > 0

    tablePosition = switch tablePositionInput
        "Left"   => position.bottom_left
        "Center" => position.bottom_center
        "Right"  => position.bottom_right

    int numDataRows   = sumMatrix.rows()
    table dataTable   = table.new(tablePosition, 8, numDataRows + 5)
    color infoBgColor = color.new(color.gray, 80)
    color textColor   = chart.fg_color
    int totalRows     = countRows(numDataRows, showMetrics, showAvgInput, showStDevInput, showPosInput)
    float cellHeight  = tableHeightInput / totalRows
    float cellWidth   = tableWidthInput / 8.0

    // Header row
    for [i, name] in dayNames
        dataTable.cell(i, 0, name, bgcolor = infoBgColor, text_color = textColor, height = cellHeight, width = cellWidth)

    // Build arrays for column stats
    var array<array<float>> colValues = array.new<array<float>>(8)
    for col = 0 to 7
        colValues.set(col, array.new<float>())

    // Data rows - compute averages from sum/count
    for row = 0 to numDataRows - 1
        int thisYear = yearIndexArray.get(row)
        dataTable.cell(0, row + 1, str.tostring(thisYear), bgcolor = infoBgColor, text_color = textColor, height = cellHeight, width = cellWidth)

        for col = 1 to 7
            int cnt = countMatrix.get(row, col)
            if cnt > 0
                float avg = sumMatrix.get(row, col) / cnt
                colValues.get(col).push(avg)
                dataTable.cell(col, row + 1, str.tostring(avg, format.percent), bgcolor = calcColor(avg, cutoffPercentInput), text_color = textColor, height = cellHeight, width = cellWidth)
            else
                dataTable.cell(col, row + 1, "-", bgcolor = color.new(color.gray, 80), text_color = textColor, height = cellHeight, width = cellWidth)

    // Metrics rows
    if showMetrics
        int divRow = numDataRows + 1
        dataTable.cell(0, divRow, "", bgcolor = infoBgColor, text_size = size.tiny, height = cellHeight, width = cellWidth)
        dataTable.merge_cells(0, divRow, 7, divRow)

        if showAvgInput
            int avgRow = numDataRows + 2
            dataTable.cell(0, avgRow, "Avgs:", bgcolor = infoBgColor, text_color = textColor, height = cellHeight, width = cellWidth)
            for col = 1 to 7
                array<float> vals = colValues.get(col)
                float avg = vals.size() > 0 ? vals.avg() : na
                string txt = na(avg) ? "-" : str.tostring(avg, format.percent)
                dataTable.cell(col, avgRow, txt, bgcolor = calcColor(avg, cutoffPercentInput), text_color = textColor, height = cellHeight, width = cellWidth)

        if showStDevInput
            int sdRow = numDataRows + 3
            dataTable.cell(0, sdRow, "StDev:", bgcolor = infoBgColor, text_color = textColor, height = cellHeight, width = cellWidth)
            for col = 1 to 7
                array<float> vals = colValues.get(col)
                float sd = vals.size() > 1 ? vals.stdev(false) : na
                string txt = na(sd) ? "-" : str.tostring(sd, "##.##")
                dataTable.cell(col, sdRow, txt, bgcolor = color.new(color.gray, 80), text_color = textColor, height = cellHeight, width = cellWidth)

        if showPosInput
            int posRow = numDataRows + 4
            dataTable.cell(0, posRow, "Pos%:", bgcolor = infoBgColor, text_color = textColor, height = cellHeight, width = cellWidth)
            for col = 1 to 7
                array<float> vals = colValues.get(col)
                float pct = vals.size() > 0 ? vals.percentPositive() : na
                string txt = na(pct) ? "-" : str.tostring(pct, '#') + "%"
                dataTable.cell(col, posRow, txt, bgcolor = calcColor(pct - 50, 50), text_color = textColor, height = cellHeight, width = cellWidth)
//#endregion
